/* ===================================
   github-sync-auto.js - CONTADOR SIMPLE
   
   Solo cuenta cambios locales sin exportar
   y los muestra en el botÃ³n githubSyncBtn
   =================================== */

(function() {
    'use strict';

    const log = (...msg) => console.log('[GitHubSync:Counter]', ...msg);
    const STORAGE_KEY = 'fftask_github_changes_count';
    const SNAPSHOT_KEY = 'fftask_github_snapshot';

    let changesCount = 0;
    let lastSnapshot = null;

    /**
     * Inicializa el contador
     */
    function init() {
        if (!window.GitHubSync?.isConnected) {
            return;
        }

        log('â–¶ Contador de cambios activado');

        // Restaurar contador y snapshot desde localStorage
        const savedCount = localStorage.getItem(STORAGE_KEY);
        const savedSnapshot = localStorage.getItem(SNAPSHOT_KEY);
        
        if (savedCount) {
            changesCount = parseInt(savedCount, 10);
            log(`ðŸ“Š Contador restaurado: ${changesCount} cambios pendientes`);
        }
        
        if (savedSnapshot) {
            lastSnapshot = savedSnapshot;
        } else {
            lastSnapshot = takeSnapshot();
            localStorage.setItem(SNAPSHOT_KEY, lastSnapshot);
        }

        // Actualizar botÃ³n con el contador restaurado
        updateButton();

        // Escuchar cambios de la app
        setupChangeDetection();
    }

    /**
     * Toma snapshot de localStorage
     */
    function takeSnapshot() {
        const excludeKeys = [
            'fftask_github_token', 
            'fftask_gist_id', 
            'fftask_last_sync',
            STORAGE_KEY,  // Excluir el contador mismo
            SNAPSHOT_KEY,  // Excluir el snapshot mismo
            'fftask_github_remote_changes'  // Excluir detector de cambios remotos
        ];
        const snapshot = {};
        
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!excludeKeys.includes(key)) {
                snapshot[key] = localStorage.getItem(key);
            }
        }
        
        return JSON.stringify(snapshot);
    }

    /**
     * Detecta si hubo cambios
     */
    function detectChanges() {
        const currentSnapshot = takeSnapshot();
        
        if (currentSnapshot !== lastSnapshot) {
            changesCount++;
            lastSnapshot = currentSnapshot;
            
            // Guardar en localStorage
            localStorage.setItem(STORAGE_KEY, changesCount.toString());
            localStorage.setItem(SNAPSHOT_KEY, lastSnapshot);
            
            log(`ðŸ“ Cambio detectado (${changesCount} cambios sin exportar)`);
            updateButton();
        }
    }

    /**
     * Escucha eventos de la app
     */
    function setupChangeDetection() {
        const events = [
            'todayTasksUpdated',
            'missionsUpdated',
            'habitsUpdated',
            'shopItemsUpdated',
            'pointsUpdated',
            'stateChanged'
        ];

        events.forEach(event => {
            window.App?.events?.on(event, (data) => {
                // Ignorar eventos automÃ¡ticos
                if (data?.autoGenerated || data?.source === 'autoTicket') {
                    return;
                }
                
                detectChanges();
            });
        });

        log('ðŸ‘‚ Escuchando cambios de la app');
    }

    /**
     * Actualiza el botÃ³n con el contador
     */
    function updateButton() {
        const syncButton = document.getElementById('githubSyncBtn');
        if (!syncButton) return;

        const syncIcon = syncButton.querySelector('.sync-icon');
        const syncText = syncButton.querySelector('.sync-text');
        
        if (!syncIcon || !syncText) return;

        // Verificar si tambiÃ©n hay cambios remotos
        const hasRemoteChanges = window.GitHubSyncImport?.hasChanges() || false;

        if (changesCount > 0 && hasRemoteChanges) {
            // Hay cambios locales Y remotos (conflicto potencial)
            syncIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
            syncText.textContent = `${changesCount} â†‘ / 1 â†“`;
            syncButton.title = `${changesCount} cambios para exportar, hay cambios para importar`;
            syncButton.style.borderColor = '#f59e0b';
            syncButton.style.background = 'rgba(245, 158, 11, 0.15)';
        } else if (changesCount > 0) {
            // Solo cambios locales - usar flecha hacia arriba
            syncIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>';
            syncText.textContent = `${changesCount}`;
            syncButton.title = `${changesCount} cambios pendientes de exportar`;
            syncButton.style.borderColor = 'rgba(var(--ff-accent-rgb), 0.5)';
            syncButton.style.background = 'rgba(var(--ff-accent-rgb), 0.15)';
        } else {
            // Sin cambios locales - dejar que github-sync-auto-import.js o github-sync-ui.js lo maneje
            if (hasRemoteChanges) {
                // Dejar que import lo maneje
            } else if (window.GitHubSyncUI) {
                window.GitHubSyncUI.updateButton();
            }
        }
    }

    /**
     * Resetea contador despuÃ©s de exportar
     */
    function onExportComplete() {
        changesCount = 0;
        lastSnapshot = takeSnapshot();
        
        // Limpiar localStorage
        localStorage.removeItem(STORAGE_KEY);
        localStorage.setItem(SNAPSHOT_KEY, lastSnapshot);
        
        log('âœ… Cambios exportados. Contador reseteado.');
        updateButton();
    }

    /**
     * API pÃºblica
     */
    window.GitHubSyncCounter = {
        getCount() {
            return changesCount;
        },

        reset() {
            onExportComplete();
        }
    };

    // Auto-inicializaciÃ³n
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(init, 1000);
        });
    } else {
        setTimeout(init, 1000);
    }
})();
